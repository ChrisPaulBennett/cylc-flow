#!/bin/bash


usage() {
    echo "USAGE: cylc email-alert EVENT SUITE TASKID MESSAGE"
    echo ""
    echo "This is a simple cylc event hook script that sends an email."
    echo "The command line arguments are supplied automatically by cylc."
    echo ""
    echo "For example, to get an email alert whenever any task fails:"
    echo ""
    echo "# SUITE.RC"
    echo "[cylc]"
    echo "   [[environment]]"
    echo "      MAIL_ADDRESS = foo@bar.baz.waz"
    echo "[runtime]"
    echo "   [[root]]"
    echo "      [[[event hooks]]]"
    echo "         events = failed"
    echo "         script = cylc email-alert"
    echo ""
    echo "See the Suite.rc Reference (Cylc User Guide) for more information"
    echo "on event hooks and event handler scripts."
}

if [[ $# = 1 ]]; then
    if [[ $1 = '--help' ]]; then
        usage
        exit 0
    fi
fi

if [[ $# < 4 ]]; then
    usage
    exit 1
fi

EVENT=$1      # e.g. "failed"
SUITE=$2      # group:name of the [failed] task
TASKID=$3       # name of the [failed] task 
MESSAGE="$4"  # quotes required (message contains spaces)

MAIL_SUBJECT="!!cylc alert!! $SUITE $TASKID $EVENT" 
MAIL_ADDRESS=${MAIL_ADDRESS:-$USER@$HOSTNAME}
MAIL_BODY="SUITE: $SUITE
TASK: $TASKID
MESSAGE: $MESSAGE"

echo "$MAIL_BODY" | mail -s "$MAIL_SUBJECT" $MAIL_ADDRESS
