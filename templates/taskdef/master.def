# MASTER CYLC TASK DEFINITION FILE: all sections annotated.
# Refer also to the cylc userguide. 
# Optional sections: [square brackets].

#         __________________________
#         |____C_O_P_Y_R_I_G_H_T___|
#         |                        |
#         |  (c) NIWA, 2008-2010   |
#         | Contact: Hilary Oliver |
#         |  h.oliver@niwa.co.nz   |
#         |    +64-4-386 0461      |
#         |________________________|

#______________________________________________________________ALL TASKS
%NAME
    # - Name[, Shortname]

    # - The optional short name can be displayed by system monitors to 
    #   help save screen real estate when viewing large systems. 
    # - Cylc commands can refer to tasks by full or short names.

    nz_forecast, nzf

#______________________________________________________________ALL TASKS
%DESCRIPTION
    # - freeform multiline text description of what this task does.

    The quick brown fox jumped over the lazy dog.

#______________________________________________________________ALL TASKS
%TYPE
    free[, oneoff, sequential, dummy, contact, catchup_contact ]

    # - Task type ('free' or 'tied') with optional type modifiers
    # - FREE tasks have no previous-instance dependence: successive
    #     instances can run in parallel if the opportunity arises.
    #     Most non-forecast model tasks should be of this type.
    # - TIED tasks have previous instance dependence through special
    #     'restart' outputs and prerequisites. 
    #     Most forecast model tasks should be of this type.
    
    # - The SEQUENTIAL modifier forces successive instances to run in
    #     sequence even if the opportunity to run in parallel arises.
    # - A task with the ONEOFF modifier does not spawn a successor.
    # - A task with the CONTACT modifier "makes contact" with the
    #     external world by waiting on some external event, usually
    #     availability or arrival of data; see %CONTACT_DELAY below.
    # - A task with the CATCHUP_CONTACT modifier is aware of whether
    #     tasks of its class have caught up to real time operation yet. 
    # - A task with the DUMMY modifier always invokes the external dummy
    #     task program, even in real operation mode.

    # SEE THE CYLC USERGUIDE FOR MORE ON TASK TYPES AND MODIFIERS.

#______________________________________________________________ALL TASKS
%CYCLES
    # - Comma separated list of cycle hours valid for this task

    0,6,12,18

#______________________________________________________________ALL TASKS
%TASK
    # - The program or script cylc must submit to run this task.
    # - Located in the system definition scripts sub-directory,
    #     or an external location (full path, or not if in $PATH)
    # - Not required by tasks with the 'dummy' modifier.

    run-foo.sh

#_______________________________________________________________________
%PREREQUISITES      
    # - Quoted string literals, one per lines.
    # - $(CYCLE_TIME), $CYCLE_TIME, or ${CYCLE_TIME} should almost
    #   certainly appear somewhere in the string to distinguish between
    #   the outputs of task instances with different cycle times.
    # - Cycle time arithmetic supported: $(CYCLE_TIME [+/- <hours>])
    # - May be conditional on cycle hour.
    # - ONE SPECIAL PREREQUISITE IS REGISTERED AUTOMATICALLY BY CYLC:
    #     + "NAME restart files ready for $CYCLE_TIME"  (TIED TASKS)
    # - You may use the automatic started, completed, finished, outputs.

           "baz finished for $(CYCLE_TIME)"
           "file bar_$(CYCLE_TIME).nc ready"
    0,12 | "foo output files ready for $(CYCLE_TIME)"

#_______________________________________________________________________
%OUTPUTS
    # - Quoted string literals, one output message per line.
    # - $(CYCLE_TIME), $CYCLE_TIME, or ${CYCLE_TIME} should almost
    #   certainly appear somewhere in the string to distinguish between
    #   the outputs of task instances with different cycle times.
    # - Cycle time arithmetic supported: $(CYCLE_TIME [+/- <hours>])
    # - SOME SPECIAL OUTPUTS ARE REGISTERED AUTOMATICALLY BY CYLC:
    #     + "NAME%CYCLE started|finished|failed|completed" (ALL TASKS)
    #     + "NAME restart files ready for CYCLE"          (TIED TASKS)
    # - May be conditional on cycle hour, as for prerequisites.
    
           "file foo-$(CYCLE_TIME).nc ready"
    0,12 | "atmos model postprocessing done for $(CYCLE_TIME)"
    6,18 | "file bar-$(CYCLE_TIME).nc ready"

#_______________________________________________________________________
[%REMOTE_HOST]
    # - URL of a remote machine on which this task must but submitted.
    # - Can be defined by an environment variable from system_config
    # - This section is not required IF the task runs on a remote
    #   machine but is submitted locally (e.g. to a cross-platform
    #   batch queue resource manager such as loadleveler).

    $SUPERCOMPUTER
 
#_______________________________________________________________________
[%CONTACT_DELAY]
    # - Only for tasks with the 'contact' modifier.
    # - Units: min, sec, hr 
    # - Task will not be submitted unless its prerequisites are
    #     satisfied AND wall clock time > task cycle time + the delay.
    # - Has no affect on case study or sufficiently delayed operation
    #     (where wall clock time > cycle time + delay).

    4.5 hr

#_______________________________________________________________________
[%OWNER]
    # - Submit the task to run under this username.
    # - Defaults to the cylc user.
    # - Can be defined by an environment variable from system_config

    bob
    # or:
    $REMOTE_MODEL_OWNER

#_______________________________________________________________________
[%ENVIRONMENT]
    # - Environment variables to export in the task execution environment
    # - The following variables are automatically set:
    #     $TASK_ID, $TASK_NAME, $CYCLE_TIME, 
    #     $CYLC_SYSTEM_NAME, $CYLC_MODE, 
    #     $CYLC_NS_HOST, $CYLC_NS_GROUP, 
    #     $CYLC_DIR, $CYLC_SYSTEM_DIR (*)
    #   The latter two are used to give the executing task access to
    #   cylc itself and to your system-specific scripts. They
    #   necessarily refer to the local cylc installation. For tasks 
    #   that will be submitted on a remote machine, you can override
    #   these variables in this section with the correct remote paths.
    # - STRINGS CONTAINING SPACES SHOULD NOT BE QUOTED.
    # - Values may contain:
    #     (i) local environment variables, e.g. $HOME or ${HOME}
    #       These are interpolated before submitting the task.
    #    (ii) $(CYCLE_TIME [+/-N])   # NOTE ROUND PARENTHESES
    #       These are interpolated by cylc before submitting the task.
    #       $(CYCLE_TIME) without +/-N is equivalent to $CYCLE_TIME.
    #   (iii) Delayed environment variables: e.g. $[HOME]
    #       These will be replaced with literal '$HOME' etc in the job
    #       script that is submitted to execute the task and thus will
    #       not be evaluated until the task executes (may be required
    #       for jobs that run on remote hosts).
    #    (iv) Other variables defined in this section.

    VARNAME     value
    REMOTE_HOME $[HOME]
    ANIMAL      foxy fox  # NOT QUOTED!

#_______________________________________________________________________
[%COMMANDLINE]
    # - Any strings listed here are concatenated to construct a
    #   commandline that will be passed to the task when it is executed.
    # - You can list all arguments on one line, or use multiple lines.
    # - cylc-wrapper passes the command line through to wrapped tasks.
    # - The command line may contain:
    #     (i) local environment variables such as $HOME
    #       These are interpolated prior to submitting the task.
    #    (ii) cylc $(CYCLE_TIME) with +/- arithmetic (see above).
    #   (iii) task-specific %ENVIRONMENT variables defined above.
    #       These are not explicitly interpolated before constructing
    #       the command line, but the effect is the same because they
    #       are defined beforehand in the environment section.
    #    (iv) Delayed environment variables, e.g. $[HOME]
    #       These will be replaced with literal '$HOME' etc in the job
    #       script that is submitted to execute the task and thus will
    #       not be evaluated until the task executes (may be required
    #       for jobs that run on remote hosts).
    # - STRINGS CONTAINING SPACES MUST BE ENCLOSED IN DOUBLE QUOTES.
    #   (and if the external task is a shell script, it must be able
    #   to extracting quoted strings from the command line.)

    --next-analysis-time $(CYCLE_TIME + 6)
    -v -h $HOME
    --quoted-arg="The quick brown $ANIMAL jumped" 

#_______________________________________________________________________
[%DIRECTIVES]
    # - Scheduler directives for qsub, loadleveler, or similar.
    # - Choose a job submit class that makes use of these.
    # - The job class will likely define some default directives, which
    #   you can add to or override here.
    # - Values can contain the cycle time variable, $(CYCLE_TIME), which
    #   will be interpolated by cylc and can make use of cylc's internal
    #   cycle time arithmetic, e.g. $( CYCLE_TIME [+/-N] ), and shell 
    #   environment variables which will be passed on to the shell.
    #   Thus $(CYCLE_TIME) is equavilent to $CYCLE_TIME except that the
    #   former version will be interpolated before reaching the shell.
    #   and can use cylc's internal cycle time arithmetic - note the
    #   parentheses to distinguish from shell environment variables.

    directive_name1 value1
    directive_name2 value2

#_______________________________________________________________________
[%COLDSTART_PREREQUISITES]
    # - Prerequisites that are only used once, at system start up.
    # - WARNING: use of this section heading exists with no prerequisites
    #   listed under it implies literally "no prerequisites" at startup. 

    "cold start files ready for $(CYCLE_TIME)"

#_______________________________________________________________________
[%N_RESTART_OUTPUTS]
    # - Required for "tied" tasks (i.e. forecast models).
    # - The number of subsequent consecutive cycles for which this task
    #   writes "restart files".
    # - May be conditional on cycle hour, as for prerequisites.
    # - Results in ONE restart PREREQUISITE and N restart OUTPUTS
    #   being registered automatically for this task.

    0,12 | 2
    6,18 | 4

#_______________________________________________________________________
[%INTERCYCLE] 
    True   # Default is False

    # - NON-RESTART INTERCYCLE DEPENDENCY INDICATOR, set True if this
    #   task has any direct downstream dependants in subsequent cycles.
    # - Not required to indicate normal tied task restart dependencies.
    # - Cylc assumes by default that tasks have only cotemporal
    #   dependants (other than restart dependencies) simply because 
    #   this will be true of the vast majority of tasks in most systems,
    #   and it allows spent tasks to be removed from the system earlier.
    # - Setting "use quick task elimination = False" in cylc preferences 
    #   is equivalent to assuming that all tasks could have general
    #   intercycle dependencies, in which case %INTERCYCLE is not needed.
#_______________________________________________________________________
[%FOLLOW_ON]
    foo

    # - This is required ONLY for oneoff tasks with INTERCYCLE=True.
    # - Name of another task to "hand the baton on to". This task will
    #   not be removed from the system until that task has finished. 
#_______________________________________________________________________
[%INHERIT]
    # - Name of another task from which to inherit taskdef properties.
    # - You must supply at least %NAME, %DESCRIPTION, and %OUTPUTS.
    # - Non-singular quantities such as prerequisites and environment
    #   variables, if provided, will entirely OVERRIDE, not add to,
    #   those defined in the parent task.
    # - Task definition files are generally so brief that there is not 
    #   a lot of benefit to inheritance, but it may save some effort
    #   when defining a lot of very similar tasks (e.g. for obs
    #   processing, or a forecast ensemble). 
    
    parent_task_name
#_______________________________________________________________________
[%LOGFILES]
    # - List of "output logs" and similar, IN ADDITION TO stdout and
    #   stderr capture from the cylc job submission process (which
    #   is are provided automatically by the job submission method
    #   where possible) to make available via the cylc gtk monitor. 
    #   This section can be used for tasks that direct their own stdout
    #   and stderr streams to named files, and for tasks with
    #   complicated native job-submission procedures that have to be
    #   invoked by cylc via a custom wrapper such that the initial
    #   process submitted by cylc is not the process that generates the
    #   output of interest. See the Userguide on Custom Job Submit Wrappers.

    $HOME/atmos/running/$CYCLE_TIME/met.out
    $HOME/atmos/running/$CYCLE_TIME/met.err
