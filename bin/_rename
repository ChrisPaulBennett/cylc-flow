#!/usr/bin/env python

import os, re, sys
from optparse import OptionParser
from registration import localdb, centraldb, regsplit, qualify, RegistrationError
from config import config, SuiteConfigError

parser = OptionParser( usage = """cylc [register] rename [options] FROM TO

rename individual suite registrations or registration groups.

Arguments:
    FROM, TO    - suite registration GROUP:NAME or GROUP""" )

parser.add_option( "-g","--group",
        help="FROM and TO are registration groups.",
        action="store_true", default=False, dest="rename_group" )

parser.add_option( "-c","--centraldb",
        help="Rename registrations from the central database.",
        action="store_true", default=False, dest="central" )

parser.add_option( "-v", "--verbose",
        help="Turn on verbose output.",
        action="store_true", default=False, dest="verbose" )

( options, args ) = parser.parse_args()

if len(args) != 2:
    parser.error( "Wrong number of arguments" )

arg_from = args[0]
arg_to = args[1]

if options.central:
    reg = centraldb()
else:
    reg = localdb()

try:
    reg.lock()
except RegistrationError, x:
    raise SystemExit(x)
reg.load_from_file()

changed = False

if not options.rename_group:
    try:
        if reg.rename( qualify( arg_from ), qualify( arg_to ), verbose=options.verbose ):
            changed = True
    except RegistrationError, x:
        reg.unlock()
        raise SystemExit(x)

else:
    try:
        if reg.rename_group( arg_from, arg_to, verbose=options.verbose ):
            changed = True
    except RegistrationError, x:
        reg.unlock()
        raise SystemExit(x)

if changed:
    reg.dump_to_file()
reg.unlock()
