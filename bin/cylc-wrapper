#!/bin/bash

# Cylc task wrapper script

# Cylc tasks must provide, at the least, their own 'started',
# 'finished', and 'failure' messages.  This script is intended to allow
# control over existing tasks without having to modify them in any way.

# Accordingly, it does the following for the wrapped task:
# (1) sends special 'started' message
# (2) executes the task
# (3) send the special 'finished' message on success,
#       or the special 'failed' message if error occurs.

# Thus WRAPPED TASKS do not need to send any messages, but they must
# provide the standard exit codes: '0' for success, '1' (or more) for
# failure. If you want, however, a wrapped task *can* send cylc
# messages as well, but in that case you might as well dispense with
# wrapping and provide your own started, finished, and failure messages
# as well.

set -e  # abort on error

# cylc exports the following environment variables for each task:
#   1. $CYCLE_TIME  
#   2. $TASK_NAME      
#   3. $WRAP          

if [[ -z $CYCLE_TIME ]]; then
    echo "ERROR, cylc-wrapper: \$CYCLE_TIME not found"
    exit 1
fi

if [[ -z $TASK_NAME ]]; then
    echo "ERROR, cylc-wrapper: \$TASK_NAME not found"
    exit 1
fi

if [[ -z $WRAP ]]; then
    echo "ERROR, cylc-wrapper: \$WRAP not found"
    exit 1
fi

#echo "cylc-wrapper: calling $TASK_NAME for $CYCLE_TIME"
cylc message "started"

# call the wrapped task
if $WRAP; then 
    # succeeded
    cylc message --all-outputs-completed
    cylc message "finished"
else
    # failed
    cylc message -p CRITICAL "failed" 
fi
