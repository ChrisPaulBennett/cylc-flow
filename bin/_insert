#!/usr/bin/env python

#         __________________________
#         |____C_O_P_Y_R_I_G_H_T___|
#         |                        |
#         |  (c) NIWA, 2008-2010   |
#         | Contact: Hilary Oliver |
#         |  h.oliver@niwa.co.nz   |
#         |    +64-4-386 0461      |
#         |________________________|

import os,sys
import cycle_time
import check_switch
import cylc_pyro_client
import port_scan
from CylcOptionParsers import PromptOptionParser

parser = PromptOptionParser( """cylc insert [options] SUITE ID

Insert a single task or a task group into a running suite. Task groups must be
defined in the suite config file located in the suite definition directory.

Inserted tasks will spawn successors as normal, unless they are 'oneoff' tasks.
See also 'cylc submit', for running single tasks without a scheduler.""",
[ 'ID                   Identity of a task or group to insert (NAME%YYYYMMDDHH)']
)

(options, args) = parser.parse_args()

if len(args) != 2:
    parser.error( "suite name and one Task or Group ID required" )

host = options.host
owner = os.environ['USER']
suite = parser.get_suite_name()

found, port = port_scan.get_port( suite, owner, host )
if not found:
    print >> sys.stderr, "suite " + suite + " is not running"
    sys.exit(1)

target = args[1]

if parser.prompt( 'Insert ' + target + ' in'):
    # check input
    try:
        ( name, cycle ) = target.split('%')
    except ValueError:
        parser.error( "Task or Group ID must be NAME%YYYYMMDDHH")
    if not cycle_time.is_valid( cycle ):
        parser.error( "invalid cycle time: " + cycle )

    god = cylc_pyro_client.client( suite, owner, host, port ).get_proxy( 'remote' )
    check_switch.check( god.insert( target,  owner ))
