#!/usr/bin/env python

#         __________________________
#         |____C_O_P_Y_R_I_G_H_T___|
#         |                        |
#         |  (c) NIWA, 2008-2010   |
#         | Contact: Hilary Oliver |
#         |  h.oliver@niwa.co.nz   |
#         |    +64-4-386 0461      |
#         |________________________|

import os,sys
import cycle_time
import cylc_pyro_client
import Pyro.errors
from CylcOptionParsers import PromptOptionParser

parser = PromptOptionParser( """cylc insert [options] SUITE ID

Insert a single task or a task group into a running suite. Task groups must be
defined in the suite config file located in the suite definition directory.

Inserted tasks will spawn successors as normal, unless they are 'oneoff' tasks.
See also 'cylc submit', for running single tasks without a scheduler.""",
[ 'ID                   Identity of a task or group to insert (NAME%YYYYMMDDHH)']
)

(options, args) = parser.parse_args()

if len(args) != 2:
    parser.error( "suite name and one Task or Group ID required" )

target = args[1]
if not parser.prompt( 'Insert ' + target + ' in'):
    sys.exit(0)

suite = parser.get_suite_name()
owner = os.environ['USER']
host = options.host
port = options.port

# check input
try:
    ( name, cycle ) = target.split('%')
except ValueError:
    parser.error( "Task or Group ID must be NAME%YYYYMMDDHH")
if not cycle_time.is_valid( cycle ):
    parser.error( "invalid cycle time: " + cycle )

try:
    proxy = cylc_pyro_client.client( suite, owner, host, port ).get_proxy( 'remote' )
    actioned, explanation = proxy.insert( target, owner )
    print explanation
except Pyro.errors.NamingError, x:
    if options.debug:
        raise
    else:
        print x
        sys.exit(1)

if not actioned:
    sys.exit(1)
