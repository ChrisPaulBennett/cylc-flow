#!/usr/bin/env python

import os,sys
import cycle_time
import cylc_pyro_client
from CylcOptionParsers import PromptOptionParser
from port_scan import SuiteIdentificationError

parser = PromptOptionParser( """cylc insert [options] SUITE ID

Insert a single task or a task group into a running suite. Task groups must be
defined in the suite config (suite.rc) file.

Inserted tasks will spawn successors as normal, unless they are 'oneoff' tasks.
See also 'cylc submit', for running single tasks without a scheduler.""",
[ 'ID                   Identity of a task or group to insert (NAME%YYYYMMDDHH)']
)

(options, args) = parser.parse_args()

if len(args) != 2:
    parser.error( "suite name and one Task or Group ID required" )

target = args[1]

suite = parser.get_suite_name()
owner = os.environ['USER']
host = options.host
port = options.port

try:
    ( name, cycle ) = target.split('%')
except ValueError:
    parser.error( "Task or Group ID must be NAME%YYYYMMDDHH")
if not cycle_time.is_valid( cycle ):
    parser.error( "invalid cycle time: " + cycle )

try:
    proxy = cylc_pyro_client.client( suite, owner, host, port ).get_proxy( 'remote' )
except SuiteIdentificationError, x:
    raise SystemExit(x)

if not parser.prompt( 'Insert ' + target + ' in'):
    sys.exit(0)

result = proxy.insert( target )

if result.success:
    print result.reason
else:
    print 'ERROR:', result.reason
    sys.exit(1)
