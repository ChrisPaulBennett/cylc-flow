#!/usr/bin/env python

#         __________________________
#         |____C_O_P_Y_R_I_G_H_T___|
#         |                        |
#         |  (c) NIWA, 2008-2010   |
#         | Contact: Hilary Oliver |
#         |  h.oliver@niwa.co.nz   |
#         |    +64-4-386 0461      |
#         |________________________|


import os, sys, re
import socket
from optparse import OptionParser
import Pyro.errors
import cylc_pyro_client
import port_scan

parser = OptionParser( """cylc ping [options] [SUITE]
    
Check if a SUITE is running, or list all running suites. 

Arguments:
SUITE             Name of a cylc suite to check on """ )

parser.add_option( "-u", "--user",
        help="Owner of the target suite (defaults to $USER).",
        metavar="USER", default=os.environ["USER"],
        action="store", dest="username" )

parser.add_option( "--host",
        help="Cylc suite host (defaults to localhost).",
        metavar="HOST", action="store", default=socket.getfqdn(),
        dest="host" )

parser.add_option( "-p", "--practice",
        help="Target a suite running in practice mode.", 
        action="store_true", default=False, dest="practice" )

( options, args ) = parser.parse_args()

host = options.host
owner = options.username

groups = []
if len( args ) == 0:
    print "Scanning ports for running cylc suites..."
    port_scan.scan( host )

elif len(args) == 1:
    suite = args[0]
    found, port = port_scan.get_port( suite, owner, host )
    if found:
        print "suite " + suite + " (" + owner + ") is running at port", port
    else:
        print "suite " + suite + ' is not running'
else:
    parser.error( "Wrong number of arguments" ) 
