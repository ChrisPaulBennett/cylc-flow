#!/usr/bin/python

import os
import re
import sys
import pyrex
import Pyro.core
from optparse import OptionParser
from time import sleep
from Pyro.errors import PyroError,NamingError

ctrl_end = "\033[0m"

def prompt( reason ):

    print reason + " '" + system_name + "':",
    response = raw_input( 'ARE YOU SURE (y/n)? ' )
    if response == 'y':
        return True
    else:
        print "Aborted!"
        return False

# construct a command line parser
parser = OptionParser( "%prog [options]" )

parser.add_option( "-p", "--pause", help="hold/pause system",
        action="store_true", default=False, dest="pause" )

parser.add_option( "-r", "--resume", help="unhold/resume system",
        action="store_true", default=False, dest="resume" )

parser.add_option( "-s", "--shutdown", help="shutdown system",
        action="store_true", default=False, dest="shutdown" )

parser.add_option( "-c", "--configured", help="use configured system",
        action="store_true", default=False, dest="use_configured" )

parser.add_option( "-n", "--name", help="system name",
        metavar="SYSTEM-NAME", action="store", dest="system_name" )

parser.add_option( "-k", "--kill", 
        help="abdicate and kill one or more tasks at a given reference time",
        metavar="<name1,name2,...>%YYYYMMDDHH", 
        action="store", dest="kill_task_id" )

parser.add_option( "-i", "--insert", help="insert a new task (EXPERIMENTAL!)",
        metavar=" <name>%<YYYYMMDDHH>", action="store", dest="insert_task_id" )

verbosity_choices = ['debug','info', 'warning', 'error', 'critical'] 

parser.add_option( "-v", "--verbosity",
        help="set verbosity: " + ', '.join(verbosity_choices),
        action="store", 
        choices=verbosity_choices,
        dest="verbosity" )

parser.add_option( "-b", "--bump", help= "bump the system",
        action="store_true", default=False, dest="bump" )

#if len( sys.argv ) == 1:
#    # no options or args supplied
#    parser.print_help()
#    sys.exit(1)

# get command line options and positional args
( options, args ) = parser.parse_args()

#if len( args ) > 1:
#    parser.error( "incorrect number of arguments" )

# get systems currently registered in the Pyro nameserver
ns_groups = pyrex.discover()

if options.use_configured:
    # use the configured system
    import config
    config = config.config()
    config.load()
    system_name = config.get( 'system_name' )

elif options.system_name:
    # use the given system name
    system_name = options.system_name
    if ns_groups.registered( system_name ):
        print "system: " + system_name
    else:
        print "WARNING: no " + system_name + " registered yet ..." 
        ns_groups.print_info()
        sys.exit(1)

else:
    # print available systems and exit
    print
    print "ERROR: you must specify a system name; use '-c' or '-n'"
    print
    parser.print_help()
    print
    ns_groups.print_info()
    print
    print "ERROR: you must specify a system name; use '-c' or '-n'"
    print
    sys.exit(1)


try:
    # connect to the remote switch object in cyclon
    control = Pyro.core.getProxyForURI('PYRONAME://' + system_name + '.' + 'remote_control' )
except NamingError:
    print "\n\033[1;37;41mfailed to connect" + ctrl_end + ' to remote switch in "' + system_name + '"'
    raise SystemExit

if options.pause:
    if prompt( 'Pause' ):
        control.hold()

if options.resume:
    if prompt( 'Resume' ):
        control.resume()

if options.shutdown:
    if prompt( 'Shutdown' ):
        if control.get_config( 'dummy_mode' ):
            # pause to prevent new dummy tasks being launched after the pkill 
            control.hold()
            print 'pausing system ...'
            sleep(5)
            print 'killing any dummy tasks ...'
            # kill any running 'dummy_task's
            os.system( 'pkill -9 -u $USER dummy-task.py' )
            sleep(5)

        control.shutdown()

if options.verbosity:
    print "requesting verbosity " + options.verbosity
    control.set_verbosity( options.verbosity )

if options.insert_task_id:
    if prompt( 'Insert ' + options.insert_task_id + ' in' ):
        print "requesting insertion of " + options.insert_task_id
        control.insert( options.insert_task_id )

if options.kill_task_id:
    if prompt( 'Kill ' + options.kill_task_id + ' in' ):
        [ tmp, reftime ] = options.kill_task_id.split( '%' )
        if re.search( ',', tmp ):
            names = tmp.split( ',' )
        else:
            names = [ tmp ]

        for name in names:
            id = name + '%' + reftime
            print "requesting abdicate and kill for " + id
            control.abdicate_and_kill( id )

        print "WARNING: you may also need to kill the REAL task(s)"


if options.bump:
    control.nudge()

#if options.bump_hours:
#DISABLED, NOT VERY USEFUL. 
#    # bump the dummy time forward. 
#    try:
#        dummy_clock = Pyro.core.getProxyForURI('PYRONAME://' + system_name + '.' + 'clock' )
#    except:
#        print "ERROR: failed to connect to the dummy clock"
#        sys.exit(1)
#    print "current time: " + str( dummy_clock.get_datetime() )
##    print "bumped on to: " + str( dummy_clock.bump( options.bump_hours ))
