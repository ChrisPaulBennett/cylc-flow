#!/usr/bin/env python

import os, sys
import cycle_time
import cylc_pyro_client
from CylcOptionParsers import PromptOptionParser
from port_scan import SuiteIdentificationError

parser = PromptOptionParser( """cylc reset [options] SUITE TASK_ID

Reset a task to the 'ready' state (all prerequisites satisfied) thereby
causing it to trigger immediately, or optionally to the 'waiting' or
'finished' states.""",
[ 'TASK_ID              Identity of the task to reset (NAME%YYYYMMDDHH).'] )

parser.add_option( "--waiting", 
        help="Reset to 'waiting' state (prerequisites not satisfied).",
        action="store_true", default=False, dest="waiting" )

parser.add_option( "--finished", 
        help="Reset to 'finished' state (outputs completed).", 
        action="store_true", default=False, dest="finished" )

(options, args) = parser.parse_args()

if len(args) != 2:
    parser.error( "Suite name and task ID required." )

if options.waiting and options.finished:
    parser.error( "Specify waiting, finished, or neither (ready)" )

ready = True
waiting = False
finished = False

if options.waiting:
    ready = False
    waiting = True
    finished = False

if options.finished:
    ready = False
    waiting = False
    finished = True

task_id = args[1]

try:
    (name, cycle ) = task_id.split('%')
except ValueError:
    parser.error( "Task or Group ID must be NAME%YYYYMMDDHH")

if not cycle_time.is_valid( cycle ):
    parser.error( "invalid cycle time: " + cycle )

suite = parser.get_suite_name()
owner = os.environ['USER']
host = options.host
port = options.port

try:
    proxy = cylc_pyro_client.client( suite, owner, host, port ).get_proxy( 'remote' )
except SuiteIdentificationError, x:
    raise SystemExit(x)

if not parser.prompt( 'Reset task ' + task_id + ' in'):
    sys.exit(0)

if waiting:
    actioned, explanation = proxy.reset_to_waiting( task_id, owner )
elif ready:
    actioned, explanation = proxy.reset_to_ready( task_id, owner )
elif options.finished:
    actioned, explanation = proxy.reset_to_finished( task_id, owner )

print explanation
if not actioned:
    sys.exit(1)
