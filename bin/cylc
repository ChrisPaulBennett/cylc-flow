#!/usr/bin/python

import sys
import subprocess

allowed_sub_commands = \
    [ 
    'server', 
    'control',
    'monitor-all',
    'monitor-dummies',
    'monitor-pyro-ns',
    'monitor-running'
    ]

name = sys.argv[0]

usage = \
    [ 
    'USAGE: ' + name + ' <command> [options] ',
    'Commands:',
    '  server              ... start scheduling a cylc system',
    '  control             ... control a running cylc system',
    '  configure-system    ... configure cylc to run a new system',
    '  monitor-all       ... monitor all cylc task proxies',
    '  monitor-dummies   ... monitor running external dummy tasks',
    '  monitor-running   ... monitor running cylc task proxies',
    '  monitor-pyro-ns   ... monitor the Pyro nameserver',
    'Options are command-dependent; see:',
    '  ' + name + ' <command> --help'
    ]

def print_usage():
    for line in usage:
        print line

try:
    sub_command = sys.argv[1]
    sub_command_options = sys.argv[2:]
except:
    print_usage()
    sys.exit(1)

if sub_command not in allowed_sub_commands:
    print_usage()
    sys.exit(1)

command = 'cylc-' + sub_command + ' ' + ' '.join( sub_command_options )
print command

try:
    # use of shell=True here provides access to PATH in the subprocess
    retcode = subprocess.call( command, shell=True )
    if retcode < 0:
        # the sub-command returned non-zero exist status
        print >> sys.stderr, command + ' failed: ', retcode
        sys.exit(1)

except OSError:
    # the sub-command was not invoked
    print >> sys.stderr, 'CYLC ERROR: unable to run sub-command ' + sub_command
    print >> sys.stderr, "Is everything under your cylc bin directory executable?"
    print >> sys.stderr, "Have you run 'cylc-configure-system' yet?"
    sys.exit(1)
