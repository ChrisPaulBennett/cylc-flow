#!/bin/bash

# given a cycon system definition directory:
#    system/user_config.py
#    system/taskdef/(task definition files)

# 1/ generate task class code for cycon
# 2/ generate system environment script 
#    + this exports PATH and PYTHONPATH, and 
#      CYCON_ENV (its own path) for system tasks
#      and CYCON_BIN for utility scripts
# 3/ copy task-wrapper from cycon/bin to system/tasks

set -e  # ABORT on error

[[ $# != 1 ]] && {
	echo "USAGE: $0 <system definition dir>"
	echo "should be run in cycon repo top level"
	exit 1
}

[[ ! -f bin/cycon ]] && {
	echo "RUN THIS IN CYCON REPO TOP LEVEL"
	exit 1
}

SYSDIR=$1
# remove any trailing '/'
SYSDIR=${SYSDIR%/}

ENV_SCRIPT='environment.sh'

TOPDIR=$PWD

# access to cycon bin/ for this script
PATH=$PWD/bin:$PATH

cd $SYSDIR

echo
echo "> generating $SYSDIR/task_classes.py"

task-generator.py taskdef/*

echo
echo "> generating environment script for this system:"
echo "     $SYSDIR/environment.sh"

cat > $ENV_SCRIPT <<EOF
#!/bin/bash

# AUTO-GENERATED BY $0

# source this to set PATH and PYTHONPATH 
# for running cycon on system $SYSDIR

# clean existing cycon paths
      PATH=\$( $TOPDIR/bin/clean-cycon-path.sh \$PATH )
PYTHONPATH=\$( $TOPDIR/bin/clean-cycon-path.sh \$PYTHONPATH )

# not using \$HOME or relative path; may be sourced by other users
PATH=$TOPDIR/bin:$TOPDIR/$SYSDIR/tasks:\$PATH
PATH=\${PATH%:}  # in case variable was empty before
PYTHONPATH=$TOPDIR/src:$TOPDIR/$SYSDIR:\$PYTHONPATH
PYTHONPATH=\${PYTHONPATH%:}  # in case was empty before
export PATH PYTHONPATH

# export my location as \$CYCON_ENV
export CYCON_ENV=$TOPDIR/$SYSDIR/$ENV_SCRIPT

# export cycon bin path for utility scripts
export CYCON_BIN=$TOPDIR/bin
EOF

# copy task-wrapper

echo
echo "> copying task-wrapper to system tasks dir"
mkdir -p $TOPDIR/$SYSDIR/tasks
cp $TOPDIR/bin/task-wrapper $TOPDIR/$SYSDIR/tasks

echo
echo "> SOURCE THE SYSTEM ENVIRONMENT SCRIPT BEFORE RUNNING CYCON"
echo "  \$ . $TOPDIR/$SYSDIR/environment.sh"
echo "  \$ cycon"
echo
