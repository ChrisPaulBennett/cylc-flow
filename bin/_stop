#!/usr/bin/env python

import os, sys, re
import cycle_time
import cylc_pyro_client
from CylcOptionParsers import PromptOptionParser
from port_scan import SuiteIdentificationError

parser = PromptOptionParser( """cylc [control] stop [options] SUITE TASK_ID

Put a waiting task into the 'stopped' state - it will not run until unstopped.
See also 'cylc [control] unstop'.""",
["""TASK_ID              Task to stop (NAME%YYYYMMDDHH)"""])

(options, args) = parser.parse_args()

if len(args) != 2:
    parser.error( "Task ID or cycle time required" )

suite = parser.get_suite_name()

target = args[1]

try:
    ( name, cycle ) = target.split('%')
except ValueError:
    parser.error( "Task ID must be NAME%YYYYMMDDHH")
if not cycle_time.is_valid( cycle ):
    parser.error( "invalid cycle time: " + cycle )

try:
    proxy = cylc_pyro_client.client( suite ).get_proxy( 'remote' )
except SuiteIdentificationError, x:
    raise SystemExit(x)

if not parser.prompt( 'Stop task ' + target + ' in'):
    sys.exit(0)

result = proxy.stop_task( target )

print result.reason
if not result.success:
    sys.exit(1)
