#!/usr/bin/env python

#C: THIS FILE IS PART OF THE CYLC FORECAST SUITE METASCHEDULER.
#C: Copyright (C) 2008-2011 Hilary Oliver, NIWA
#C: 
#C: This program is free software: you can redistribute it and/or modify
#C: it under the terms of the GNU General Public License as published by
#C: the Free Software Foundation, either version 3 of the License, or
#C: (at your option) any later version.
#C:
#C: This program is distributed in the hope that it will be useful,
#C: but WITHOUT ANY WARRANTY; without even the implied warranty of
#C: MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#C: GNU General Public License for more details.
#C:
#C: You should have received a copy of the GNU General Public License
#C: along with this program.  If not, see <http://www.gnu.org/licenses/>.


from shutil import rmtree
import os, re, sys
from optparse import OptionParser
from cylc.registration import getdb, RegistrationError
from cylc.config import config, SuiteConfigError

parser = OptionParser( usage = """cylc [db] unregister|delete [OPTIONS] SUITE

Remove suite (or suite group) registrations from your private, or the
central, suite database.  By default this does not actually delete 
suite definition directories.

If you accidentally unregister a running suite, just reregister it under
the same GROUP:NAME name to regain access to it.

Arguments:
    SUITE - suite registration:
            OWNER:GROUP:NAME (Central DB), or
                  GROUP:NAME (Private DB), or
          or registration group (note trailing colon!):
            OWNER:GROUP: (Central DB), or 
                  GROUP: (Private DB)""" )

parser.add_option( "--obliterate",
        help="Delete the suite definition directory too (!DANGEROUS!).",
        action="store_true", default=False, dest="obliterate" )

parser.add_option( "--force",
        help="Don't ask for confirmation before obliterating suite definitions",
        action="store_true", default=False, dest="force" )

parser.add_option( "--gcylc",
        help="(DO NOT USE THIS OPTION).",
        action="store_true", default=False, dest="gcylc" )

parser.add_option( "-v", "--verbose",
        help="Turn on verbose output.",
        action="store_true", default=False, dest="verbose" )

( options, args ) = parser.parse_args()

if len(args) != 1:
    parser.error( "Wrong number of arguments" )

suite = args[0]

try:
    db = getdb( suite )
    db.lock()
    db.load_from_file()
except RegistrationError, x:
    raise SystemExit(x)

dirs = []

group_unreg = False
m = re.match( '^(\w+):(\w+):$', suite)
if m:
    owner, group = m.groups()
    group_unreg = True
else:
    n = re.match( '^(\w+):$', suite)
    if n:
        group_unreg = True
        group = n.groups()[0]

if group_unreg:
    if options.obliterate:
        try:
            regs = db.get_list( groupfilt='^' + group + '$' )
        except RegistrationError, x:
            raise SystemExit(x)
        else:
            for suite, dir, descr in regs:
                dirs.append(dir)
    try:
        db.unregister_group_fast( group )
    except RegistrationError, x:
        print >> sys.stderr, x
        db.unlock()
        sys.exit(1)
    else:
        db.dump_to_file()
        db.unlock()
else:
    if options.obliterate:
        try:
            dir, descr = db.get( suite )
        except RegistrationError, x:
            db.unlock()
            raise SystemExit(x)
        else:
            dirs.append(dir)
 
    try:
        db.unregister( suite, verbose=options.verbose )
    except RegistrationError, x:
        print >> sys.stderr, x
        db.unlock()
        sys.exit(1)
    else:
        db.dump_to_file()
        db.unlock()

# TO DO: should this be inside the db lock in the case of
# central copied registrations (probably not).
if options.obliterate:
    really_obliterate = False
    print "Suite(s) successfully unregistered."
    if options.gcylc or options.force:
        # confirmed by dialog
        really_obliterate = True
    else:
        response = raw_input( "DO YOU REALLY WANT TO DELETE THE SUITE DEFINITION DIRECTORY(S) (y/n)?" )
        if response == 'y':
            really_obliterate = True
    if really_obliterate and len(dirs)>0:
        print "DELETING SUITE DEFINITIONS:"
        for dir in dirs:
            print '  - ', dir
            try:
                rmtree(dir)
            except OSError, x:
                print >> sys.stderr, "Failed to delete " + dir
                print >> sys.stderr, x
