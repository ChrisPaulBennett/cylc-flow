#!/usr/bin/env python

#         __________________________
#         |____C_O_P_Y_R_I_G_H_T___|
#         |                        |
#         |  (c) NIWA, 2008-2010   |
#         | Contact: Hilary Oliver |
#         |  h.oliver@niwa.co.nz   |
#         |    +64-4-386 0461      |
#         |________________________|

import re, sys
import cycle_time
import cylc_pyro_client
from CylcOptionParsers import NoPromptOptionParser_u

def print_heading( strng ):
        underline = re.sub( '.', '_', strng )
        print underline
        print strng

parser = NoPromptOptionParser_u( """cylc show [options] SYSTEM [TASK_NAME] [TASK_ID]

Print descriptive information about a running system, or a task class
from the system, or complete information about a specific task from the
system (current state of its prerequisites and outputs and, for contact
tasks, whether or not the delayed start time is up).""",
["""TASK_NAME            Name of a system task class - print description.
   TASK_ID              ID (NAME%YYYYMMDDHH) - also print prerequisites etc."""] )

(options, args) = parser.parse_args()

prnt_sys = False
prnt_name = False
prnt_id = False

if len(args) == 2:
    target = args[1]
    try:
        name, cycle = target.split( '%' )
    except ValueError:
        prnt_name = True
        name = target
    else:
        prnt_id = True
else:
    prnt_sys = True
 
sysname = parser.get_system_name()

host = parser.get_pns_host()
group = parser.get_groupname()

god = cylc_pyro_client.client( host, group ).get_proxy( 'remote' )

if prnt_sys:
    # print system information and exit
    ( title, sysdef_dir, username, info ) = god.get_sys_info()

    print title
    print ' * ' + username + ': ' + sysname + ' --> ' + sysdef_dir
    for item in info.keys():
        print ' + ' + item + ': ' +  info[item]

    print
    sys.exit(0)

# print task description
info = god.get_task_info( [ name ] )

print_heading( 'Task ' + name + ' in ' + sysname + ':' )
for name in info.keys():
    for line in info[name]:
        print '  ' + line

if prnt_name:
    sys.exit(0)

if not cycle_time.is_valid( cycle ):
    parser.error( "invalid cycle time: " + cycle )

id = target
result = god.get_task_requisites( [ id ] )

if id not in result:
    print "Task " + id + " not found in " + sysname
    sys.exit(1)

# PREREQUISTIES AND OUTPUTS

for id in result.keys():
    [ pre, out, extra_info ] = result[ id ]

    print_heading( id + ' prerequisites (- => not satisfied):')
    if len( pre ) == 0:
        print '  (None)'
    for item in pre:
        [ msg, state ] = item
        if state:
            descr = '  + '
        else:
            descr = '  - '
        print descr + msg

    print_heading( id + ' outputs (- => not completed):' )
    if len( out ) == 0:
        print '  (None)'
    for item in out:
        [ msg, state ] = item
        if state:
            descr = '  + '
        else:
            descr = '  - '
        print descr + msg

    if len( extra_info.keys() ) > 0:
        print_heading( 'Other:' )
        for item in extra_info:
            print '  o ', item, '...', extra_info[ item ]
