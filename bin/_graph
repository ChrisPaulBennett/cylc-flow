#!/usr/bin/env python

import os, re, sys
import gtk
import gtk.gdk
import gobject
from optparse import OptionParser

try:
    from graphing import xdot
except:
    raise SystemExit( "Graphing not available; install pygraphviz and xdot")

import config

class MyDotWindow( xdot.DotWindow ):
    """Override xdot to get rid of the Open and Refresh buttons"""

    ui = '''
    <ui>
        <toolbar name="ToolBar">
            <toolitem action="ZoomIn"/>
            <toolitem action="ZoomOut"/>
            <toolitem action="ZoomFit"/>
            <toolitem action="Zoom100"/>
        </toolbar>
    </ui>
    '''
    def __init__(self, suite, ctime, stop_after, raw ):
        self.suite = suite
        self.ctime = ctime
        self.raw = raw
        self.stop_after = stop_after

        gtk.Window.__init__(self)

        self.graph = xdot.Graph()

        window = self

        window.set_title('Suite Dependency Graph Viewer')
        window.set_default_size(512, 512)
        vbox = gtk.VBox()
        window.add(vbox)

        self.widget = xdot.DotWidget()

        # Create a UIManager instance
        uimanager = self.uimanager = gtk.UIManager()

        # Add the accelerator group to the toplevel window
        accelgroup = uimanager.get_accel_group()
        window.add_accel_group(accelgroup)

        # Create an ActionGroup
        actiongroup = gtk.ActionGroup('Actions')
        self.actiongroup = actiongroup

        # Create actions
        actiongroup.add_actions((
            ('ZoomIn', gtk.STOCK_ZOOM_IN, None, None, None, self.widget.on_zoom_in),
            ('ZoomOut', gtk.STOCK_ZOOM_OUT, None, None, None, self.widget.on_zoom_out),
            ('ZoomFit', gtk.STOCK_ZOOM_FIT, None, None, None, self.widget.on_zoom_fit),
            ('Zoom100', gtk.STOCK_ZOOM_100, None, None, None, self.widget.on_zoom_100),
        ))

        # Add the actiongroup to the uimanager
        uimanager.insert_action_group(actiongroup, 0)

        # Add a UI descrption
        uimanager.add_ui_from_string(self.ui)

        # Create a Toolbar
        toolbar = uimanager.get_widget('/ToolBar')
        vbox.pack_start(toolbar, False)

        vbox.pack_start(self.widget)

        self.set_focus(self.widget)

        self.show_all()

    def parse_graph( self ):
        #print 'ullo'
        # reparse the graph
        self.suiterc = config.config( self.suite )
        self.suitercfile = self.suiterc.get_filename()
        self.set_dotcode( self.suiterc.get_graph( self.ctime, self.stop_after, self.raw ).string() )

    def update(self):
        # if suite config file has changed, reparse the graph
        if not hasattr(self, "last_mtime"):
            self.last_mtime = None
        current_mtime = os.stat(self.suitercfile).st_mtime
        if current_mtime != self.last_mtime:
            self.last_mtime = current_mtime
            self.parse_graph()
        return True

if __name__ == '__main__':
    parser = OptionParser( """cylc graph SUITE 

Plot suite dependency graphs in a pannable, zoomable viewer.

By default, the graph configured in the suite config (suite.rc)
file [dependency graph] section will be plotted. The graph will
update automatically as you edit the suite.

You can also view the run-time dependency graph for the suite, 
which records resolved dependencies as the suite runs.

Arguments:
  SUITE   - registered name of the suite.""")

    parser.add_option( "-c", "--coldstart", 
        help="Hour at which to plot a suite.rc coldstart graph.",
        metavar="HH", action="store", default=None, dest="coldstart_hour" )

    parser.add_option( "-r", "--rawstart", 
        help="Hour at which to plot a suite.rc rawstart graph.",
        metavar="HH", action="store", default=None, dest="rawstart_hour" )

    parser.add_option( "-s", "--stop-after", 
        help="Stop plotting the suite.rc graph HH hours beyond the start hour (default 6)",
        metavar="HH", action="store", default='06', dest="stop_after" )

    parser.add_option( "-f", "--filename", 
        help="View a specific dot-language graphfile.",
        metavar="FILE", action="store", default=None, dest="filename" )

    parser.add_option( "--run-time-graph", 
        help="Plot the suite run-time graph, if one has been generated.",
        action="store_true", default=False, dest="view_runtime" )

    ( options, args ) = parser.parse_args()

    if len(args) != 1:
        parser.error( "wrong number of arguments" )

    suite = args[0]

    view_file = False
    if options.view_runtime:
        view_file = True
        suiterc = config.config( suite )
        file = os.path.join( suiterc['visualization']['run time graph directory'],
                              suiterc['visualization']['run time graph filename'] )
        if options.filename:
            view_file = True
            file = options.filename

    if view_file:
        window = xdot.DotWindow()
        try:
            window.update( file )
        except OSError, x:
            print x
            sys.exit(1)
        window.connect( 'destroy', gtk.main_quit)
        # checking for file changed not necessary for the run time graph:
        # gobject.timeout_add(1000, window.update, file)
        gtk.main()

    else:
        # parse and plot the suite.rc dependency graph
        if options.coldstart_hour:
            hour = options.coldstart_hour
            raw = False
        elif options.rawstart_hour:
            hour = options.rawstart_hour
            raw = True
        else:
            parser.error( "Illegal input" )

        if not re.match( '\d\d', hour ):
            parser.error( "Illegal hour value " + hour )

        # fake a full cycle time
        ctime = '29990101' + hour
        window = MyDotWindow( suite, ctime, options.stop_after, raw )
        window.parse_graph()
        window.connect( 'destroy', gtk.main_quit)
        gobject.timeout_add(1000, window.update)
        gtk.main()
