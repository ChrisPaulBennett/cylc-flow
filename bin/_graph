#!/usr/bin/env python

#C: THIS FILE IS PART OF THE CYLC FORECAST SUITE METASCHEDULER.
#C: Copyright (C) 2008-2011 Hilary Oliver, NIWA
#C: 
#C: This program is free software: you can redistribute it and/or modify
#C: it under the terms of the GNU General Public License as published by
#C: the Free Software Foundation, either version 3 of the License, or
#C: (at your option) any later version.
#C:
#C: This program is distributed in the hope that it will be useful,
#C: but WITHOUT ANY WARRANTY; without even the implied warranty of
#C: MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#C: GNU General Public License for more details.
#C:
#C: You should have received a copy of the GNU General Public License
#C: along with this program.  If not, see <http://www.gnu.org/licenses/>.

import os, re, sys
from time import sleep
from cycle_time import ct, CycleTimeError
import gtk
import gtk.gdk
import gobject
from optparse import OptionParser
import config

try:
    from cylc_xdot import MyDotWindow
except Exception, x:
    print >> sys.stderr, str(x)
    raise SystemExit( "Cylc graphing disabled" )

parser = OptionParser( """1/ cylc [prep] graph [options] SUITE START [STOP]
     Plot the configured (suite.rc) dependency graph for SUITE.
       2/ cylc [prep] graph [options] -r,--runtime SUITE
     Plot the run-time dependency graph for SUITE, if one has been generated.
       3/ cylc [prep] graph [options] -f,--file FILE
     Plot the specified dot-language graph file.

Plot cylc dependency graphs in a pannable, zoomable viewer.

For the configured (suite.rc) graph, the viewer updates automatically
when the suite.rc file is saved during editing. By default the full 
graph from cold start is plotted; you can omit suite cold start tasks
with the '-w,--warmstart' option. 

Graph viewer controls:
    * Left-click to center the graph on a node.
    * Left-drag to pan the view.
    * Zoom buttons, mouse-wheel, or ctrl-left-drag to zoom in and out.
    * Shift-left-drag to zoom in on a box.
    * "Best Fit" and "Normal Size" - self-explanatory.

Arguments:
  SUITE   - suite registration [OWNER:]GROUP:NAME
  START   - Initial cycle time (YYYYMMDDHH) to plot.
  [STOP]  - Final cycle time (YYYYMMDDHH) to plot (default START+ 6 hours).
  """)

#parser.add_option( "-l", "--live", 
#    help="Update image in real time if the source file changes. Otherwise "
#    "the user can hit the viewer Refresh button.  This option is OFF by "
#    "default because the graph will recenter when refreshed, which is "
#    "unhelpful if you are studying a panned, zoomed image.",
#    action="store_true", default=False, dest="updatelive" )

parser.add_option( "-w", "--warmstart", 
    help="Plot the raw start graph instead of cold start.",
    action="store_true", default=False, dest="rawstart" )

parser.add_option( "-f", "--file", 
    help="View a specific dot-language graphfile.",
    metavar="FILE", action="store", default=None, dest="filename" )

parser.add_option( "-r", "--runtime", 
    help="Plot the suite run-time graph, if one has been generated "
    "($CYLC_SUITE_DIR/graphing/runtime.dot).",
    action="store_true", default=False, dest="view_runtime" )

parser.add_option( "-o", "--output", 
    help="Write an image file with format determined by file extension. "
    "The image will be rewritten automatically, for the configured "
    "(suite.rc) graph as you edit the suite. Available formats may "
    "include png, svg, jpg, gif, ps, ..., depending on your graphviz "
    "build; to see what's available specify a non-existent format "
    "and read the resulting error message.",
    metavar="FILE", action="store", default=None, dest="outputfile" )

( options, args ) = parser.parse_args()

view_file = False
if options.view_runtime:
    if len(args) != 1:
        parser.error( 'run-time graphing requires one argument (SUITE)' )
        sys.exit(1)
    view_file = True

    suite = args[0]
    try:
        suiterc = config.config( suite )
    except config.SuiteConfigError, x:
        print >> sys.stderr, x
        sys.exit(1)
    file = os.path.join( suiterc['visualization']['run time graph directory'], 'runtime-graph.dot')
if options.filename:
    if len(args) != 0:
        parser.error( 'file graphing arguments: \'-f FILE\' or \'--file=FILE\'' )
        sys.exit(1)
    view_file = True
    file = options.filename

if view_file:
    try:
        from xdot import DotWindow
    except:
        raise SystemExit( "Failed to import the xdot viewer.")
    window = DotWindow()
    try:
        window.update( file )
    except OSError, x:
        print >> sys.stderr, x
        sys.exit(1)
    window.connect( 'destroy', gtk.main_quit)
    #if options.updatelive:
    # checking periodically for file changed
    gobject.timeout_add(1000, window.update, file)
    gtk.main()
    sys.exit(0)

# parse and plot the suite.rc dependency graph
if len(args) < 2 or len(args) > 3:
    parser.error( "suite.rc graphing requires args SUITE START [STOP]" )

suite = args[0]

try:
    start_ctime = ct(args[1]).get()
except CycleTimeError,x:
    raise SystemExit(x)

if len(args) == 3:
    try:
        stop_ctime = ct(args[2])
    except CycleTimeError,x:
        raise SystemExit(x)
    stop_delta = stop_ctime.subtract( stop_ctime, ct(start_ctime) )
    # timedelta: days, seconds, microseconds; ignoring microseconds
    stop = stop_delta.days * 24 + stop_delta.seconds / 3600
else:
    stop = 0

raw = False
if options.rawstart:
    raw = True

#print start_ctime, stop
window = MyDotWindow( suite, start_ctime, stop, raw, options.outputfile )
try:
    window.parse_graph()
except config.SuiteConfigError, x:
    raise SystemExit(x)
window.connect( 'destroy', gtk.main_quit)
#if options.updatelive:
# checking periodically for file changed
gobject.timeout_add(1000, window.update)
gtk.main()
