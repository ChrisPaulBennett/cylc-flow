#!/usr/bin/env python

import os, re, sys
from optparse import OptionParser
from registration import localdb, centraldb, unqualify, RegistrationError

parser = OptionParser( usage = """cylc export [FILTER options]

Export your registered suites to the central suite database.

See also:
    cylc centraldb - view and delete central suite registrations
    cylc import    - import suites from the central suite database
    cylc register  - manage your local suite registrations""" )

parser.add_option( "-g", "--group",
        help="Group filter Regular Expression.",
        metavar="RE", action="store", default=None, dest="groupfilt" )

parser.add_option( "-n", "--name",
        help="Name filter Regular Expression.",
        metavar="RE", action="store", default=None, dest="namefilt" )

( options, args ) = parser.parse_args()

if len(args) != 0:
    parser.error('Commandline error')

local = localdb()
central = centraldb() 

# check for valid regular expressions:
for filt in options.groupfilt, options.namefilt:
    if filt:
        try:
            re.compile( filt )
        except:
            raise SystemExit( 'Bad expression: ' + filt )

suites = local.get_list( groupfilt=options.groupfilt, namefilt=options.namefilt )
if len( suites ) == 0:
    raise SystemExit( "ERROR, No matching suites to export" )

for suite, dir, descr in suites:
    # retrieve local registration
    try:
        dir,descr = local.get( suite )
    except RegistrationError, x:
        raise SystemExit(x)

    # export to central
    try:
        central.register( suite, dir, descr )
    except RegistrationError, x:
        raise SystemExit(x)

central.dump_to_file()
