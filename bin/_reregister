#!/usr/bin/env python

import os, re, sys
from optparse import OptionParser
from registration import getdb, RegistrationError
from config import config, SuiteConfigError

parser = OptionParser( usage = """cylc [db] reregister [options] FROM TO

reregister local or central suite registrations or registration groups.

Arguments:
    FROM, TO    - suite registrations: 
    FROM, TO        - central OWNER:GROUP:NAME
                    - local   GROUP:NAME
                - OR registration groups:
                    - central OWNER:GROUP: (note trailing colon!)
                    - local   GROUP:       (note trailing colon!)""" )

parser.add_option( "-v", "--verbose",
        help="Turn on verbose output.",
        action="store_true", default=False, dest="verbose" )

( options, args ) = parser.parse_args()

if len(args) != 2:
    parser.error( "Wrong number of arguments" )

arg_from = args[0]
arg_to = args[1]

reg = getdb( arg_from )

m = re.match( '^(.*):$', arg_from )
n = re.match( '^(.*):$', arg_to )
if m:
    reregister_group = True
    group_from = m.groups()[0]
    if n:
        group_to = n.groups()[0]
    else:
        raise SystemExit( 'Inconsistent command arguments' )
else: 
    reregister_group = False

try:
    reg.lock()
except RegistrationError, x:
    raise SystemExit(x)
reg.load_from_file()

changed = False

if not reregister_group:
    try:
        if reg.reregister( arg_from, arg_to, verbose=options.verbose ):
            changed = True
    except RegistrationError, x:
        reg.unlock()
        raise SystemExit(x)

else:
    try:
        if reg.reregister_group( group_from, group_to, verbose=options.verbose ):
            changed = True
    except RegistrationError, x:
        reg.unlock()
        raise SystemExit(x)

if changed:
    reg.dump_to_file()
reg.unlock()
