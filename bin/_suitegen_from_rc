#!/usr/bin/env python

import sys
import re
import suiterc
import taskdef

rc = suiterc.suiterc( sys.argv[1] + '/suite.rc' )

print rc.config.sections()

for ( label, line ) in rc.config.items( 'graph' ):
    print label, ':', line

commands = {}
for ( name, command ) in rc.config.items( 'commands' ):
   commands[name] = command

types = {}
modifiers = {}
for ( name, type_list ) in rc.config.items( 'task types' ):
    if re.match( '^\w+,', type_list ):
        elements = re.split( ',\s*', type_list, )
        types[ name ] = elements[0]
        modifiers[ name ] = elements[1:]
    else:
        types[name] = type_list

default_hours = rc.get( 'general', 'default cycles' )
hours = re.split( ',\s*', default_hours )

names = []
suite = []
for line in rc.config.items( 'graph' ):
    label, the_rest = line
    sequence = re.split( '\s*->\s*', the_rest )
    count = 0
    tasks = []
    for name in sequence:
        if name not in names:
            names.append( name )
            task = taskdef.taskdef( name )
            tasks.append( task )
            task.hours = hours
            task.add_default_output() 
            if name in types:
                task.set_type( types[name] )
            if name in modifiers:
                print name, modifiers[name]
                task.set_modifiers( modifiers[name] )

            if count > 0:
                task.add_default_prerequisite( tasks[count-1].name )
            
            count += 1

    suite.extend( tasks )

for task in suite:
    print task.name
    task.write_task_class( 'configured' )
