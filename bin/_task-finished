#!/usr/bin/env python

import sys
import cylc_mode
from optparse import OptionParser
from task_message import message
from task_lock import task_lock

usage = """cylc task-finished [options]

This is part of the cylc external task interface.

Release my lock to the lockserver, and report that I have finished."""

parser = OptionParser( usage )

( options, args ) = parser.parse_args()

if len( args ) != 0:
    print >> sys.stderr, "WARNING: ignoring task-finished arguments:"
    for arg in args:
        print sys.stderr, arg

if not cylc_mode.mode().is_raw():
    try:
        if not task_lock().release():
            msg = "FAILED TO RELEASE TASK LOCK"
            message( msg, 'WARNING' ).send()
            # this implies a bug in the lockserver, maybe? but is not a
            # task failure condition (the task completed successfully).
    except:
        # failed to connect to lockserver
        msg = "FAILED TO CONNECT TO A LOCKSERVER"
        message( msg, 'WARNING' ).send()
 
message().send_finished()
