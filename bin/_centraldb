#!/usr/bin/env python

import os, re, sys
from optparse import OptionParser
from registration import centraldb, RegistrationError

parser = OptionParser( usage = """cylc centraldb [options] [FILTER]

View or delete central suite database registrations, with filtering
by suite owner and registration group. By default every entry in the
database will be printed.

See also:
    cylc export
    cylc import

Arguments:
    FILTER     OWNER or OWNER:GROUP""" )

parser.add_option( "-w", "--wipe",
        help="Delete all of your central registrations.",
        action="store_true", default=False, dest="wipe" )

parser.add_option( "-v", "--verbose",
        help="Verbose registration listings.",
        action="store_true", default=False, dest="verbose" )

( options, args ) = parser.parse_args()

if len(args) > 1:
    parser.error( "Wrong number of arguments" )

central = centraldb() 

if options.wipe:
    central.unregister_all()
    central.dump_to_file()
    sys.exit(0)

groupfilt = []
ownerfilt = []

if len(args) == 1:
    filter = args[0]
    m = re.match( '^(\w+):(\w+)', filter )
    if m:
        owner, group = m.groups()
        ownerfilt.append( owner )
        groupfilt.append( group )
    else:
        owner = filter
        ownerfilt.append( owner )

central.print_all( ownerfilt=ownerfilt, groupfilt=groupfilt, verbose=options.verbose )

