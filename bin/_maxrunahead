#!/usr/bin/env python

import os, sys
import cylc_pyro_client
from CylcOptionParsers import PromptOptionParser
from port_scan import SuiteIdentificationError

parser = PromptOptionParser("""cylc [control] maxrunahead [options] SUITE [HOURS] 

Change the suite runahead limit in a running suite. This is the number of 
hours that the fastest task is allowed to get ahead of the slowest. If a 
task spawns beyond that limit it will be held back from running until the
slowest tasks catch up enough. WARNING: if you omit HOURS no limit will
be used!""",
[ 'HOURS                New runahead limit (no limit if omitted).'] )

(options, args) = parser.parse_args()

if len(args) == 0 or len(args) > 2:
    parser.error( "Wrong number of arguments." )

runahead = None
if len(args) == 2:
    runahead = args[1]

suite = parser.get_suite_name()

try:
    proxy = cylc_pyro_client.client( suite ).get_proxy( 'remote' )
except SuiteIdentificationError, x:
    raise SystemExit(x)

if not parser.prompt( 'Change suite runahead limit to ' + runahead ):
    sys.exit(0)

result = proxy.set_runahead( runahead )

if result.success:
    print result.reason
else:
    print 'ERROR:', result.reason
    sys.exit(1)
