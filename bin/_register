#!/usr/bin/env python

import os, re, sys
from optparse import OptionParser
from registration import localdb, RegistrationError
from config import get_suite_title, SuiteConfigError

parser = OptionParser( usage = """cylc [db] register [options] SUITE PATH

Add a new local cylc suite registration, which associates a suite name with
a suite definition directory (stored in $HOME/.cylc/registrations). Cylc
commands target a particular suite using its registered name.

Arguments:
     SUITE  -  local registration GROUP:NAME
     PATH   -  A cylc suite definition directory location.
    
If you accidentally delete the registration of a running suite, just
reregister it under the same name to regain access to the suite.""" )

parser.add_option( "-v", "--verbose",
        help="Turn on verbose output.",
        action="store_true", default=False, dest="verbose" )

( options, args ) = parser.parse_args()

if len(args) != 2:
    parser.error( "Wrong number of arguments" )

# NEW REGISTRATION: cylc register SUITE PATH
suite = args[0]
rdir = args[1]
if not os.path.isdir( rdir ):
    print "Second argument is not a valid directory: " + rdir
    print "Trying reversed arguments..."
    # + cylc register PATH SUITE 
    suite = args[1]
    rdir = args[0]
if not os.path.isdir( rdir ):
    raise SystemExit( 'ERROR: Suite definition PATH not valid' )

# get suite title by parsing the config file
try:
    title = get_suite_title( path=rdir )
except SuiteConfigError,x:
    raise SystemExit(x)

reg = localdb()
try:
    reg.lock()
except RegistrationError, x:
    raise SystemExit(x)

reg.load_from_file()
try:
    reg.register( suite, rdir, title )
except RegistrationError, x:
    print >> sys.stderr, x
    reg.unlock()
    sys.exit(1)
reg.unlock()
reg.dump_to_file()
sys.exit(0)
