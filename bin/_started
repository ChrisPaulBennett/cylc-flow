#!/usr/bin/env python

import sys
import cylc_mode
from optparse import OptionParser
from task_message import message
from task_lock import task_lock

usage = """cylc [task] started [options]

This is part of the cylc external task interface.

Acquire a lock from the lockserver, and report that I have started."""

parser = OptionParser( usage )

( options, args ) = parser.parse_args()

if len( args ) != 0:
    parser.error( "Wrong number of arguments" )

message().send_started()

if not cylc_mode.mode().is_raw():
    try:
        if not task_lock().acquire():
            # If using the lockserver, failing to acquire a lock is an error
            msg = "FAILED TO ACQUIRE A TASK LOCK" 
            message( msg ).send_failed()
            sys.exit(1)
    except:
        # failed to connect to lockserver
        msg = "FAILED TO CONNECT TO A LOCKSERVER" 
        message( msg ).send_failed()
        sys.exit(1)
