#!/usr/bin/env python

#         __________________________
#         |____C_O_P_Y_R_I_G_H_T___|
#         |                        |
#         |  (c) NIWA, 2008-2010   |
#         | Contact: Hilary Oliver |
#         |  h.oliver@niwa.co.nz   |
#         |    +64-4-386 0461      |
#         |________________________|


""" 
Commandline interface to the $HOME/.cylcrc preferences file.
"""

import sys
from optparse import OptionParser
from preferences import prefs

usage = """cylc preferences [options]

Manage your global cylc preferences, stored in $HOME/.cylcrc."""

parser = OptionParser( usage )

parser.add_option( "-p", "--print", 
        help="Print your current preferences.",
        action="store_true", default=False, dest="print_all" )
 
parser.add_option( "--set-defaults", 
        help="Revert to system default settings.",
        action="store_true", default=False, dest="set_defaults" )

parser.add_option( "--use-lockserver", 
        help="Control use of the cylc lock server.",
        metavar='Y/N', action="store", dest="use_lockserver" )

parser.add_option( "--use-quick-elimination", 
        help="Control use of the quick task elimination algorithm.",
        metavar='Y/N', action="store", dest="use_quick" )

parser.add_option( "--set-logging-dir", 
        help="Set the top level cylc server logging directory.",
        default=None, metavar="PATH",
        action="store", dest="logging_dir" )

parser.add_option( "--set-state-dump-dir", 
        help="Set the top level cylc state dump directory.",
        default=None, metavar="PATH",
        action="store", dest="statedump_dir" )

parser.add_option( "--set-lockserver-pidfile", 
        help="Set the cylc lockserver Process ID file path.",
        default=None, metavar="PATH",
        action="store", dest="lockserver_pidfile" )

parser.add_option( "--set-lockserver-logfile", 
        help="Set the cylc lockserver log file path.",
        default=None, metavar="PATH",
        action="store", dest="lockserver_logfile" )

parser.add_option( "--user", help="Attempt read-only access to another "
        "user's preferences.", 
        default=None, metavar="USER", action="store", dest="user" )

parser.add_option( "--create-directories", 
        help="Create all directories specified in your preferences file. "
        "(this is done automatically when you change directory settings).",
        action="store_true", default=False, dest="create_dirs" )

( options, args ) = parser.parse_args()

if len( args ) > 0 or len( sys.argv ) == 1:
    parser.print_help()
    sys.exit(0)

# load existing cylcrc file
rcfile = prefs( options.user )

rewrite = False

if options.print_all:
    rcfile.dump()

if options.set_defaults:
    rcfile.set_defaults()
    rewrite = True

if options.use_lockserver:
    use = options.use_lockserver
    rewrite = True
    if use == 'Y' or use == 'y':
        rcfile.config[ 'cylc' ][ 'use lockserver' ] = 'True'
    elif use == 'N' or use == 'n':
        rcfile.config[ 'cylc' ][ 'use lockserver' ] = 'False'
    else:
        parser.error( 'unknown argument: ' + use )

if options.use_quick:
    use = options.use_quick
    rewrite = True
    if use == 'Y' or use == 'y':
        rcfile.config[ 'cylc' ][ 'use quick task elimination' ] = 'True'
    elif use == 'N' or use == 'n':
        rcfile.config[ 'cylc' ][ 'use quick task elimination' ] = 'False'
    else:
        parser.error( 'unknown argument: ' + use )

if options.lockserver_pidfile:
    rcfile.config[ 'lockserver' ][ 'pid file' ] = options.lockserver_pidfile
    rewrite = True

if options.lockserver_logfile:
    rcfile.config[ 'lockserver' ][ 'log file' ] = options.lockserver_logfile
    rewrite = True

if options.logging_dir:
    rcfile.config[ 'cylc' ][ 'logging directory' ] = options.logging_dir
    rewrite = True

if options.statedump_dir:
    rcfile.config[ 'cylc' ][ 'state dump directory' ] = options.statedump_dir
    rewrite = True

if options.create_dirs:
    rcfile.create_dirs()

if rewrite:
    rcfile.write()
