#!/bin/bash

#C: THIS FILE IS PART OF THE CYLC FORECAST SUITE METASCHEDULER.
#C: Copyright (C) 2008-2011 Hilary Oliver, NIWA
#C: 
#C: This program is free software: you can redistribute it and/or modify
#C: it under the terms of the GNU General Public License as published by
#C: the Free Software Foundation, either version 3 of the License, or
#C: (at your option) any later version.
#C:
#C: This program is distributed in the hope that it will be useful,
#C: but WITHOUT ANY WARRANTY; without even the implied warranty of
#C: MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#C: GNU General Public License for more details.
#C:
#C: You should have received a copy of the GNU General Public License
#C: along with this program.  If not, see <http://www.gnu.org/licenses/>.

# This script creates the central suite database and registers the
# cylc example suites in it. Rerunning it will cause no ill effects.

# Steps:
# 1/ register the example suites in the cylc owner's local db
# 2/ export the example suites to the central database
# 3/ set central db file permissions appropriately

set -e

usage() {
    echo ""
    echo "USAGE: cylc [admin] create-cdb"
    echo ""
    echo "This admin command should be used by the cylc administrator"
    echo "to create the central suite registration database immediately"
    echo "after installing cylc. It can be run multiple times without"
    echo "any adverse affect."
}

if [[ $1 == '-h' ]] || [[ $1 == '--help' ]]; then
    usage
    exit 0
fi

if [[ -z CYLC_DIR ]]; then
    echo "export \$CYLC_DIR before running this script."
    exit 1
fi

echo
echo " + Registering examples suites"
cylc register examples:test $CYLC_DIR/examples/test

cylc register examples:CUG_1 $CYLC_DIR/examples/CUG1

cylc register examples:CUG_QS1 $CYLC_DIR/examples/CUG_QS/one
cylc register examples:CUG_QS2 $CYLC_DIR/examples/CUG_QS/two
cylc register examples:CUG_QS3 $CYLC_DIR/examples/CUG_QS/three

cylc register examples:CUG_73 $CYLC_DIR/examples/CUG7.3
cylc register examples:CUG_74 $CYLC_DIR/examples/CUG7.4

cylc register examples:FFHook $CYLC_DIR/examples/AutoCleanup/FamilyFailHook
cylc register examples:FFTask $CYLC_DIR/examples/AutoCleanup/FamilyFailTask

cylc register examples:detach $CYLC_DIR/examples/detach

cylc register examples:async_oneoff $CYLC_DIR/examples/async/oneoff
cylc register examples:async_repeat $CYLC_DIR/examples/async/repeating

cylc register examples:autorecover_async $CYLC_DIR/examples/AutoRecover/async
cylc register examples:autorecover_cycle $CYLC_DIR/examples/AutoRecover/cycling

cylc register examples:generator_explicit $CYLC_DIR/examples/generator/explicit
cylc register examples:generator_expression $CYLC_DIR/examples/generator/expression

cylc register examples:families $CYLC_DIR/examples/families

echo
echo " + Exporting examples suites to the central database"
# Export the example suites to the central database.
# This will create the new database file.
cylc export examples:

echo " + Unregistering the originals in your private database"
# So even the admin user has to import *copies* of the example suites
# from the central database - so that he/she cannot modify the originals 
# by accident. 
cylc unregister examples:

# Determine CDB directory location
# The following no longer works (see comment in lib/cylc/__init__.py)
# CDB=$(python -c 'from cylc.conf.CylcGlobals import central_regdb_dir; print central_regdb_dir')
# Use new secret command instead:
CDB=$(cylc print-cdb-dir)

echo
echo " + Setting central database permissions: $CDB"

# Make the central db writeable by all.
# (could be just g+w if all cylc users are in the same group).
chmod go+rwx $CDB
chmod go+rw $CDB/db

echo "DONE"
