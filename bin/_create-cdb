#!/bin/bash

#C: THIS FILE IS PART OF THE CYLC FORECAST SUITE METASCHEDULER.
#C: Copyright (C) 2008-2011 Hilary Oliver, NIWA
#C: 
#C: This program is free software: you can redistribute it and/or modify
#C: it under the terms of the GNU General Public License as published by
#C: the Free Software Foundation, either version 3 of the License, or
#C: (at your option) any later version.
#C:
#C: This program is distributed in the hope that it will be useful,
#C: but WITHOUT ANY WARRANTY; without even the implied warranty of
#C: MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#C: GNU General Public License for more details.
#C:
#C: You should have received a copy of the GNU General Public License
#C: along with this program.  If not, see <http://www.gnu.org/licenses/>.

# This script creates the central suite database and registers the
# cylc example suites in it. Rerunning it will cause no ill effects.

# Steps:
# 1/ register the example suites in the cylc owner's local db
# 2/ export the example suites to the central database
# 3/ set central db file permissions appropriately

set -e

usage() {
    echo ""
    echo "USAGE: cylc [admin] create-cdb"
    echo ""
    echo "This admin command should be used by the cylc administrator"
    echo "to create the central suite registration database immediately"
    echo "after installing cylc, or to upgrade the centrally held cylc"
    echo "example suites after upgrading to a new cylc version. It can"
    echo "be run multiple times without adverse effect."
}

if [[ $1 == '-h' ]] || [[ $1 == '--help' ]]; then
    usage
    exit 0
fi

if [[ -z CYLC_DIR ]]; then
    echo "export \$CYLC_DIR before running this script."
    exit 1
fi

if cylc db print --fail admin.test > /dev/null 2>&1; then 
    echo " + Unregistering the existing admin.test suite"
    cylc unregister admin.test
fi
echo " + Registering the admin.test suite"
cylc register admin.test $CYLC_DIR/examples/test

# register locally under seconds since epoch, to avoid clashes
# with example suites imported to the admin user's private db.
SSE=$( date +%s )

echo " + Registering example suites"
cylc register ${SSE}.examples.CUG.1 $CYLC_DIR/examples/CUG1

cylc register ${SSE}.examples.CUG.QS1 $CYLC_DIR/examples/CUG_QS/one
cylc register ${SSE}.examples.CUG.QS2 $CYLC_DIR/examples/CUG_QS/two
cylc register ${SSE}.examples.CUG.QS3 $CYLC_DIR/examples/CUG_QS/three

cylc register ${SSE}.examples.CUG.73 $CYLC_DIR/examples/CUG7.3
cylc register ${SSE}.examples.CUG.74 $CYLC_DIR/examples/CUG7.4

cylc register ${SSE}.examples.AutoCleanup.FFHook $CYLC_DIR/examples/AutoCleanup/FamilyFailHook
cylc register ${SSE}.examples.AutoCleanup.FFTask $CYLC_DIR/examples/AutoCleanup/FamilyFailTask

cylc register ${SSE}.examples.detach $CYLC_DIR/examples/detach

cylc register ${SSE}.examples.inherit $CYLC_DIR/examples/inherit

cylc register ${SSE}.examples.async.oneoff $CYLC_DIR/examples/async/oneoff
cylc register ${SSE}.examples.async.repeat $CYLC_DIR/examples/async/repeating

cylc register ${SSE}.examples.autorecover.async $CYLC_DIR/examples/AutoRecover/async
cylc register ${SSE}.examples.autorecover.cyclng $CYLC_DIR/examples/AutoRecover/cycling

cylc register ${SSE}.examples.generator.explicit $CYLC_DIR/examples/generator/explicit
cylc register ${SSE}.examples.generator.expression $CYLC_DIR/examples/generator/expression

cylc register ${SSE}.examples.families $CYLC_DIR/examples/families

if cylc db print --central --fail ${USER}.examples > /dev/null 2>&1; then 
    echo " + Unregistering the existing ${USER}.examples group from the central database"
    cylc unregister --central --delete --force ${USER}.examples
fi

echo " + Exporting examples suites to the central database"
# Export the example suites to the central database.
# This will create the new database file if necessary.
cylc export ${SSE}.examples examples

echo " + Unregistering the originals in your private database"
# This way even the admin user has to import *copies* of the example
# suites from the CDB - and not modify the originals by accident. 
cylc unregister ${SSE}

# Determine CDB directory location
# The following no longer works (see comment in lib/cylc/__init__.py)
# CDB=$(python -c 'from cylc.conf.CylcGlobals import central_regdb_dir; print central_regdb_dir')
# Use new secret command instead:
CDB=$(cylc print-cdb-dir)

echo " + Setting central database permissions: $CDB"

# Make the central db writeable by all.
# (could be just g+w if all cylc users are in the same group).
chmod go+rwx $CDB
chmod go+rw $CDB/db

echo "DONE"
