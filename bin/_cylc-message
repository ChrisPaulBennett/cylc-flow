#!/usr/bin/python

""" 
This is a messaging interface between external tasks and the proxy
objects that represent them inside a cylc scheduler instance: the
message is sent by calling [proxy].incoming( PRIORITY, MESSAGE )
through the Pyro RPC mechanism. 
The task proxy is identified by its unique ID, NAME%YYYYMMDDHH

Cylc exports $CYLC_NS_HOST, $CYLC_NS_GROUP, $CYLC_TIME, and 
$CYLC_TASK into the environment of each external task.
"""

import os
import sys
import Pyro.core
from Pyro.errors import NamingError, ProtocolError
from optparse import OptionParser
from time import sleep

# PARSE THE COMMAND LINE-----------------------------------------------
usage = """
General messages:
   cylc message [options] MESSAGE 
Automatic messages:
  cylc message [--started OR --succeeded OR --failed]
  cylc message [--set-all-restarts-completed OR --set-all-outputs-completed]

Send a message to a task proxy object in a running cylc instance.

THIS COMMAND IS USED BY TASKS TO COMMUNICATE WITH THEIR CYLC TASK PROXY
OBJECTS, in which case most inputs are taken from environment variables. 
It can also be used by cylc system operators to fake messages from tasks,
for debugging purposes, in which case the command line options can be used.

Note that where other commands need to know a registered system name, this
command needs the Pyro nameserver group name, {USERNAME}_{NAME}, where 
USERNAME is the username of the owner of system NAME."""

parser = OptionParser( usage )

parser.set_defaults( started=False, success=False, failure=False, 
        all_restarts_completed=False, all_outputs_completed=False,
        priority='NORMAL')

parser.add_option( "-t", 
        metavar='NAME',
        help="task name, defaults to $CYLC_TASK",
        action="store", dest="taskname" )

parser.add_option( "-g",
        metavar="NAME",
        help="Pyro nameserver group name used by objects in the target "
        "system, defaults to $CYLC_NS_GROUP.",
        action="store", dest="groupname" )

parser.add_option( "-n", 
        help="Hostname of the machine running the Pyro nameserver, "
            "defaults to $CYLC_NS_HOST, then localhost",
        metavar="HOSTNAME", action="store", dest="pns_host" )

parser.add_option( "--started",
        help="Send a special message indicating a task has"
        "started executing",
        action="store_true", dest="started" )

parser.add_option( "--succeeded",
        help="Send a special message indicating a task has"
        "completed successfully",
        action="store_true", dest="succeeded" )

parser.add_option( "--failed",
        help="Send a special message indicating a task has"
        "failed to complete successfully",
        action="store_true", dest="failed" )

parser.add_option( "-p",
        metavar="PRIORITY",
        type="choice",
        choices=[ 'NORMAL', 'WARNING', 'CRITICAL' ],
        help="message logging priority, default NORMAL",
        action="store", dest="priority" )

parser.add_option( "-c",
        metavar="YYYYMMDDHH",
        help="task cycle time, defaults to $CYLC_TIME",
        action="store", dest="ctime" )

parser.add_option( "--all-restart-outputs-completed", 
        help="report all forecast model restart outputs completed at once",
        action="store_true", dest="all_restarts_completed" )

parser.add_option( "--all-outputs-completed", 
        help="report all task outputs completed at once "
             "EXCEPT for the special 'completed' and 'finished' outputs",
        action="store_true", dest="all_outputs_completed" )

( options, args ) = parser.parse_args()

# GET TASK NAME--------------------------------------------------------
if options.taskname:
    # command line
    taskname = options.taskname
else:
    # Default to $CYLC_TASK
    if 'CYLC_TASK' in os.environ.keys():
        taskname = os.environ[ 'CYLC_TASK' ]
    else:
        print 'ERROR, cylc message: no task name provided'
        sys.exit(1)

# GET SYSTEM NAME------------------------------------------------------
if options.groupname:
    # command line
    groupname = options.groupname
else:
    # Default to $CYLC_NS_GROUP
    if 'CYLC_NS_GROUP' in os.environ.keys():
        groupname = os.environ[ 'CYLC_NS_GROUP' ]
    else:
        print 'ERROR, cylc message: no system name provided'
        sys.exit(1)

# GET PYRO NAMESERVER HOST---------------------------------------------
if options.pns_host:
    # command line
    pns_host = options.pns_host

elif 'CYLC_NS_HOST' in os.environ.keys():
    # environment
   pns_host = os.environ[ 'CYLC_NS_HOST' ]

else:
    # Default to localhost
    pns_host = 'localhost'
    print 'WARNING, cylc message: no Pyro nameserver hostname provided!'
    print 'will attempt to connect to a namerserver on localhost'
     
# GET TASK CYCLE TIME--------------------------------------------------
if options.ctime:
    # command line
    ctime = options.ctime
else:
    # Default to $CYLC_TIME
    if 'CYLC_TIME' in os.environ.keys():
        ctime = os.environ[ 'CYLC_TIME' ]
    else:
        print 'ERROR, cylc message: no cycle time provided!'
        sys.exit(1)
 
# CHECK ARGS AND OPTIONS-----------------------------------------------

# the automatic messaging options must be used alone
if options.started or options.succeeded or options.failed \
        or options.all_restarts_completed \
        or options.all_outputs_completed:
   if len( sys.argv ) != 2:
       print "cylc message ERROR: no other options or arguments"
       print "are allowed with --started, --succeeded, or --failed"
       sys.exit(1)

elif len( args ) == 0:
    parser.error( "no message supplied" )

elif len( args ) == 1:
    # quoted string supplied
    message = args[0]

else:
    # bare string supplied
    message = ' '.join(args)

# CONNECT TO THE CORRECT TASK PROXY OBJECT-----------------------------
count = 0
while True:
    count += 1
    try:
        task = Pyro.core.getProxyForURI('PYRONAME://' + pns_host + '/' + groupname + '.' + taskname + '%' + ctime )
       
    except ProtocolError:
        # retry if temporary network problems prevented connection

        # TO DO: do we need to single out just the 'connection failed error?'

        # http://pyro.sourceforge.net/manual/10-errors.html
        # Exception: ProtocolError,
        #    Error string: connection failed
        #    Raised by: bindToURI method of PYROAdapter
        #    Description: Network problems caused the connection to fail.
        #                 Also the Pyro server may have crashed.
        #                 (presumably after connection established - hjo)

        print 'cylc message [' + str( count ) + ']: Network Problems, RETRYING in 5 seconds'
        sleep(5)

    except NamingError:
        # can't find nameserver, or no such object registered ...
        print 'PYRO NAMESERVER ERROR'
        raise

    except Exception:
        # all other exceptions
        print 'ERROR'
        raise

    else:
        # successful connection
        break

# DO THE MESSAGING----------------------------------------------------

# the "all completed" special options are implemented as short cut
# functions in the task proxy objects

task_id = taskname + '%' + ctime

if options.all_restarts_completed:
    # set all forecast model restart outputs completed
    task.set_all_restarts_completed()
    sys.exit(0)

if options.all_outputs_completed:
    task.set_all_internal_outputs_completed()
    sys.exit(0)

if options.started:
    task.incoming( 'NORMAL', task_id + " started" )

elif options.succeeded:
    task.incoming( 'NORMAL', task_id + " completed" )
    task.incoming( 'NORMAL', task_id + " finished" )

elif options.failed:
    task.incoming( 'NORMAL', task_id + " completed" )
    task.incoming( 'CRITICAL', task_id + " failed" )

else:
    task.incoming( 'NORMAL', message )

#    # nameserver not found, or object not registered with it?
#    print "ERROR: failed to connect to " + task_name + "_" + ctime
#    print "Trying dead letter box"
#    try:
#        dead_box = Pyro.core.getProxyForURI('PYRONAME://' + groupname + '.' + 'dead_letter_box' )
#        dead_box.incoming( message )
#    except:
#        # nameserver not found, or object not registered with it?
#        print "ERROR: failed to connect to pyro nameserver"
#        sys.exit(1)
