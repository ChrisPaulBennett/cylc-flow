#!/usr/bin/env python

from mkdir_p import mkdir_p
import os, re, sys
from shutil import copytree
from optparse import OptionParser
from registration import localdb, centraldb, regsplit, RegistrationError
from regprompt import prompt

parser = OptionParser( usage = """cylc [db] import [OPTIONS] CENTRAL [LOCAL] DIR

Import suites or groups from the central registration database.

Arguments:
    CENTRAL, LOCAL  - OWNER:GROUP:NAME, OWNER:GROUP.
    DIR    - destination for the imported suite definition (must not exist).
             or top level directory for imported groups.""" )

( options, args ) = parser.parse_args()

if len(args) != 2 and len(args) != 3:
    parser.error('Illegal number of arguments')

local = localdb()
central = centraldb() 

arg_central = args[0]
if len(args) == 2:
    arg_local = arg_central
    arg_dir = args[1]
else:
    arg_local = args[1]
    arg_dir = args[2]

topdir = arg_dir

m = re.match( '^(\w+):(\w+):$', arg_central )
n = re.match( '^(.*):$', arg_local )
if m:
    # copy a whole group
    fromowner, fromgroup = m.groups()
    if n:
        togroup = n.groups()[0]
    else:
        raise SystemExit( 'Inconsistent command arguments' )

    # retrieve registrations
    central.load_from_file()
    try:
        csuites = central.get_list( ownerfilt='^' + fromowner + '$',
                groupfilt='^' + fromgroup + '$' )
    except RegistrationError, x:
        raise SystemExit(x)

    print 'Matched:'
    for csuite, cdir, cdescr in csuites:
        cowner, cgroup, cname = regsplit( csuite ).get()
        print '  ', cowner + ':' + cgroup + ':' + cname

    # import to local
    try:
        local.lock()
    except RegistrationError, x:
        raise SystemExit(x)
    local.load_from_file()
    changed = False
 
    for csuite, cdir, cdescr in csuites:
        cowner, cgroup, cname = regsplit( csuite ).get()
        lgroup = togroup
        lname = cname

        #ldir = os.path.join( topdir, lgroup, lname )
        ldir = os.path.join( topdir, lname )
        if os.path.exists( ldir ):
            print >> sys.stderr, 'WARNING: skipping import, directory already exists: ' + ldir
            continue
        lreg = lgroup + ':' + lname
        try:
            local.register( lreg, ldir, cdescr )
        except RegistrationError, x:
            print >> sys.stderr, x
        else:
            # Make path absolute in case user specified a single
            # component relative path such as "foo", in which case
            # os.path.dirname(ldir), below, returns an empty string.
            ldir = os.path.abspath( ldir )
            print 'Copying suite definition'
            try:
                mkdir_p( os.path.dirname(ldir))
            except Exception,x:
                print >> sys.stderr, x
                local.unregister(lreg)
            else:
                try:
                    copytree( cdir, ldir )
                except OSError, x:
                    print >> sys.stderr,x
                    local.unregister( lreg )
                else:
                    changed = True
    if changed:
        local.dump_to_file()
    local.unlock()

else:
    # single suite
    creg = arg_central
    lreg = arg_local
    ldir = arg_dir

    # retrieve central registration
    central.load_from_file()
    try:
        cdir, cdescr = central.get( creg )
    except RegistrationError, x:
        raise SystemExit(x)

    if os.path.exists( ldir ):
        raise SystemExit( 'ERROR, destination directory already exists: ' + ldir )

    # import to local
    try:
        local.lock()
    except RegistrationError, x:
        raise SystemExit(x)
    local.load_from_file()
 
    try:
        local.register( lreg, ldir, cdescr )
    except RegistrationError, x:
        local.unlock()
        raise SystemExit(x)
    else:
        # Make path absolute in case user specified a single
        # component relative path such as "foo", in which case
        # os.path.dirname(ldir), below, returns an empty string.
        ldir = os.path.abspath( ldir )
        print 'Copying suite definition'
        try:
            mkdir_p( os.path.dirname(ldir))
        except Exception,x:
            print >> sys.stderr, x
            local.unregister( lreg )
            local.unlock()
        else:
            try:
                copytree( cdir, ldir )
            except OSError, x:
                print >> sys.stderr,x
                local.unregister( lreg )
                local.unlock()
            else:
                local.dump_to_file()
                local.unlock()

