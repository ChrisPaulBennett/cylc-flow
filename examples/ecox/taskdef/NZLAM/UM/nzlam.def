# THIS IS A CYLC TASK DEFINITION FILE

%TASK
    UM_nzlam, nzl

%DESCRIPTION
    NZLAM warm cycle forecast

%TYPE
    # handling restart dependencies explicitly
    free, sequential

%HOURS
    0,6,12,18

%OWNER
    nwp

%INTERCYCLE
    True

%COMMAND
    UM-wrapper.sh
    # retry on failure(uncomment when diagnosis script implemented):
      # 1/ diagnose-gridpoint-storm.sh
      # 2/ UM-wrapper.sh --3minTS  

%ENVIRONMENT
    UMUI_JOBDIR   $WARMSTART_JOBDIR

%SCRIPTING
    export UM_PPVARFILE=$( cylcutil template TEMPLATE_PPVAR_FILE )
    export UM_PP7CXFILE=$( cylcutil template TEMPLATE_PP7CX_FILE )
    export UM_DATAMDIR=$(  cylcutil template TEMPLATE_DATAM_DIR  )
    export UM_DATAWDIR=$(  cylcutil template TEMPLATE_DATAW_DIR  )
    export UM_ALABCFILE=$( cylcutil template TEMPLATE_ALABC_FILE )
    export UM_VARINCFILE=$( cylcutil template TEMPLATE_VAR_INCR_FILE )
    if [[ $( cylcutil cycle-time --hour ) == 00 ]]; then
        export UM_STARTDUMP=$( cylcutil template -s 6 $TEMPLATE_RECONFIGURED_RESTART_DUMP )
    else
        export UM_STARTDUMP=$( cylcutil template -s 6 $TEMPLATE_RESTART_DUMP )
    fi
    export UM_LOGDIR=$( cylcutil template TEMPLATE_LOGFILE_DIR )
  
%PREREQUISITES
    "NZLAM LBC file ready for $(CYCLE_TIME)"
    "NZLAM analysis increments ready for $(CYCLE_TIME)"
    if HOUR in 0:
        "Reconfigured NZLAM restart dump ready for $(CYCLE_TIME)"
    if HOUR in 6,12,18:
        "NZLAM restart dump ready for $(CYCLE_TIME)"

%OUTPUTS
    "NZLAM forecast fieldsfiles ready for $(CYCLE_TIME)"
    "OPS Cx background file ready for $(CYCLE_TIME + 6)"
    "VAR LS background file ready for $(CYCLE_TIME + 6)"
    "NZLAM restart dump ready for $(CYCLE_TIME + 6)"
    # TO DO: how many restart dumps are we writing?
    #"NZLAM restart dump ready for $(CYCLE_TIME + 12)"
    #"NZLAM restart dump ready for $(CYCLE_TIME + 18)"

