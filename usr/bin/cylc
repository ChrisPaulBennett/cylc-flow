#!/usr/bin/env bash

# THIS FILE IS PART OF THE CYLC SUITE ENGINE.
# Copyright (C) NIWA & British Crown (Met Office) & Contributors.
# 
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

#------------------------------------------------------------------------------
# Wrapper script to support multiple Cylc versions installed on the same host.
# Handles Conda and Python virtual envs, and plain Cylc 7 installations.
#
# WRAPPER INSTALLATION AND CONFIGURATION
#---------------------------------------
# Copy this script as "cylc" into the default $PATH on scheduler and job hosts,
# and modify CYLC_HOME_ROOT(_ALT) below (see "EDIT ME") to point to the parent
# directory of all installed versions.
#
# HOW IT WORKS
#-------------
# Intercept "cylc" commands and re-invoke them with the appropriate cylc-flow
# version, according to location or version information in the environment:
# + 1) $CYLC_HOME if defined, or
# + 2) $CYLC_HOME_ROOT[_ALT]/$CYLC_VERSION
#
# In Cylc 8+ the scheduler sets CYLC_VERSION=cylc.flow.__version__ in task
# job environments so jobs get the same version as their parent scheduler.
# The__version__ string increments with releases so CYLC_VERSION cannot be
# used for fine-grained selection among (e.g.) git working copies between
# releases. Use CYLC_HOME to select a venv in your cylc-flow git clone.
#
# INSTRUCTIONS FOR USERS
#-----------------------
# + Set CYLC_VERSION to select an installed version under the root location
#   - this is just the version string, e.g. "8.0.0"
#   - if setting it in .bashrc, be sure to default to an existing value to
#       avoid overiding task job version selection, e.g.:
#     $ export CYLC_VERSION=${CYLC_VERSION:-8.0.0}
#   - do not explicitly select the default "cylc" symlink as a version
# + Set CYLC_HOME in .bashrc (on scheduler and job hosts) to select a specific
#     version outside of the ROOT location
#   - this should point to a Cylc 8 venv, or a Cylc 7 installation directory.
#     It must be set in .bashrc so that task jobs see it (otherwise they will
#     select CYLC_VERSION as set by the parent scheduler)
#
# INSTALLING CYLC RELEASES WITH CONDA
#------------------------------------
# Create environments named cylc-$CYLC_VERSION under a root location such as /opt:
#   $ conda create -p /opt/cylc-8.2.0 cylc=8.2.0
# and create a default version symlink "cylc" to the latest version:
#   $ ls /opt/cylc*
#   cylc-8.1.0
#   cylc-8.2.0
#   cylc
#
# Note you can `pip install` cylc-flow from a git clone into a Conda
# environment and then select it by CYLC_VERSION but that will be misleading
# if the code is not the true release version. It may be better to use Python
# venvs and CYLC_HOME for cylc-flow development and testing.
#
# INSTALLING CYLC-FLOW WORKING COPIES WITH PIP FOR DEVELOPMENT AND TESTING
#-------------------------------------------------------------------------
# Create Python virtual environments in-place in your cylc-flow git
# clones and select them using CYLC_HOME in your .bashrc.
#
# Create a new venv and install cylc-flow:
#   $ cd <my-cylc-flow-clone>
#   $ python -m venv venv
#   $ . venv/bin/activate
#   $ pip install -e . 
#
# Set CYLC_HOME in .bashrc to select this venv (see explanation above):
#   $ echo "export CYLC_HOME=$PWD/venv" >> ~/.bashrc
#   $ . ~/.bashrc
#
# Note you can also `pip install` cylc-flow releases under a common root
# location for CYLC_VERSION based selection, like for Conda:
#   $ CYLC_HOME_ROOT=$HOME/cylc-flow/releases  # (set in this wrapper too)
#   $ python -m venv $CYLC_HOME_ROOT/cylc-8.0a2
#   $ . $CYLC_HOME_ROOT/cylc-8.0a2/bin/activate
#   $ python -m pip install cylc-flow==8.0a2
# But there is no need to do this if you also have full system releases (as
# opposed to cylc-flow only) installed by Conda.
 
##############################!!! EDIT ME !!!##################################
# Centrally installed Cylc releases:
CYLC_HOME_ROOT="${CYLC_HOME_ROOT:-/opt}"
# For an alternate location set CYLC_HOME_ROOT_ALT.
# CYLC_HOME_ROOT_ALT=${HOME}/miniconda3/envs
###############################################################################

# If CYLC_HOME is not defined try CYLC_HOME_ROOT/cylc-CYLC_VERSION
if [[ -z "${CYLC_HOME}" && -n ${CYLC_VERSION} ]]; then
    # Look for matching version in root locations
    for ROOT in "${CYLC_HOME_ROOT}" "${CYLC_HOME_ROOT_ALT}"; do
        if [[ -d "${ROOT}/cylc-${CYLC_VERSION}" ]]; then
            CYLC_HOME="${ROOT}/cylc-${CYLC_VERSION}"
            break
        fi
    done
fi
if [[ -z "${CYLC_HOME}" ]]; then
    echo 1>&2 "ERROR: CYLC_HOME not defined or found"
    exit 1
fi

# Find and activate the virtual env, or find the Cylc 7 bin directory.
BASENAME_PREFIX=""
if [[ -f "${CYLC_HOME}/bin/activate" ]]; then
    # A Python venv or Conda pack installation
    . "${CYLC_HOME}/bin/activate" || exit 1
elif [[ -d "${CYLC_HOME}"/conda-meta && \
        -f "${CYLC_HOME%/*/*}"/etc/profile.d/conda.sh ]]; then
    # A normal Conda environment
    . "${CYLC_HOME%/*/*}"/etc/profile.d/conda.sh
    conda activate "${CYLC_HOME##*/}" || exit 1
elif [[ -x "${CYLC_HOME}/bin/cylc" ]]; then
    # A Cylc 7 installation
    BASENAME_PREFIX="${CYLC_HOME}"/bin/
else
    echo 1>&2 "ERROR: cylc not found in ${CYLC_HOME}"
    exit 1
fi

# Execute the command via the selected Cylc installation.
exec "${BASENAME_PREFIX}${0##*/}" "$@"
